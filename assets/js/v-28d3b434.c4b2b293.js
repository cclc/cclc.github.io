"use strict";(self.webpackChunkcclc_vuepress=self.webpackChunkcclc_vuepress||[]).push([[5918],{6543:(n,s,a)=>{a.r(s),a.d(s,{data:()=>t});const t={key:"v-28d3b434",path:"/nodejs/nodejs-monitor-wechat-public-account-event.html",title:"NodeJS监控微信公众号关注事件推送",lang:"zh-CN",frontmatter:{title:"NodeJS监控微信公众号关注事件推送",date:"2018-07-16",categories:["NodeJS","WeChat"],tags:["NodeJS","WeChat"]},excerpt:"",headers:[{level:2,title:"1.首先要在微信公众号后台填写服务器信息。",slug:"_1-首先要在微信公众号后台填写服务器信息。",children:[]},{level:2,title:"2.在服务器上配置具体代码反馈微信的验证",slug:"_2-在服务器上配置具体代码反馈微信的验证",children:[]},{level:2,title:"3.和关注、取消关注相关的业务逻辑代码",slug:"_3-和关注、取消关注相关的业务逻辑代码",children:[]}],git:{},filePathRelative:"nodejs/nodejs-monitor-wechat-public-account-event.md"}},6641:(n,s,a)=>{a.r(s),a.d(s,{default:()=>r});var t=a(6252);const p=(0,t._)("h1",{id:"nodejs-监控微信公众号关注事件推送",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#nodejs-监控微信公众号关注事件推送","aria-hidden":"true"},"#"),(0,t.Uk)(" NodeJS 监控微信公众号关注事件推送")],-1),e={class:"table-of-contents"},o=(0,t._)("h2",{id:"_1-首先要在微信公众号后台填写服务器信息。",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#_1-首先要在微信公众号后台填写服务器信息。","aria-hidden":"true"},"#"),(0,t.Uk)(" 1.首先要在微信公众号后台填写服务器信息。")],-1),c={href:"https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421135319",target:"_blank",rel:"noopener noreferrer"},i=(0,t.uE)('<h2 id="_2-在服务器上配置具体代码反馈微信的验证" tabindex="-1"><a class="header-anchor" href="#_2-在服务器上配置具体代码反馈微信的验证" aria-hidden="true">#</a> 2.在服务器上配置具体代码反馈微信的验证</h2><p>如第三步的</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> params<span class="token punctuation">.</span>echostr<span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_3-和关注、取消关注相关的业务逻辑代码" tabindex="-1"><a class="header-anchor" href="#_3-和关注、取消关注相关的业务逻辑代码" aria-hidden="true">#</a> 3.和关注、取消关注相关的业务逻辑代码</h2><p>这里我使用了 xml2js 将 xml 转成对象和 js-sha1 来生成 sha1 加密字符串</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token constant">XMLJS</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;xml2js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> sha1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;js-sha1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 解析URL里的参数</span>\n<span class="token keyword">const</span> params <span class="token operator">=</span> Url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span>query<span class="token punctuation">;</span>\n<span class="token comment">// 微信传来的加密字符串</span>\n<span class="token keyword">const</span> signature <span class="token operator">=</span> params<span class="token punctuation">.</span>signature<span class="token punctuation">;</span>\n<span class="token comment">// 根据传来的其他值计算加密字符串</span>\n<span class="token keyword">const</span> timestamp <span class="token operator">=</span> params<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>\n<span class="token keyword">const</span> nonce <span class="token operator">=</span> params<span class="token punctuation">.</span>nonce<span class="token punctuation">;</span>\n<span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token string">&quot;weixin&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 这是在公众平台上自己设置的</span>\n<span class="token keyword">const</span> array <span class="token operator">=</span> <span class="token punctuation">[</span>token<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">]</span><span class="token punctuation">;</span>\narray<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> scyptoString <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span>array<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 比对两个加密字符串是否相等，相等则为微信官方传来的信息</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>scyptoString <span class="token operator">===</span> signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 获取请求内的xml参数</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 将xml解析</span>\n    <span class="token constant">XMLJS</span><span class="token punctuation">.</span><span class="token function">parseString</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> event <span class="token operator">=</span> result<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>Event<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">===</span> <span class="token string">&quot;subscribe&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// 订阅，获取用户基本信息存入订阅表，建议使用非同步写法以加快response</span>\n          <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span><span class="token function">saveSubscibeUser</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>FromUserName<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">===</span> <span class="token string">&quot;unsubscribe&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// 取消订阅</span>\n          <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span><span class="token function">deleteSubscibeUser</span><span class="token punctuation">(</span>\n            result<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>FromUserName<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\n          <span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// 假如服务器无法保证在五秒内处理并回复，可以直接回复空串，微信服务器不会对此作任何处理，并且不会发起重试</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>echostr<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 用于通过微信验证</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> params<span class="token punctuation">.</span>echostr<span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>',6),u={href:"https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421140454",target:"_blank",rel:"noopener noreferrer"},l={},r=(0,a(3744).Z)(l,[["render",function(n,s){const a=(0,t.up)("RouterLink"),l=(0,t.up)("ExternalLinkIcon");return(0,t.wg)(),(0,t.iD)(t.HY,null,[p,(0,t._)("nav",e,[(0,t._)("ul",null,[(0,t._)("li",null,[(0,t.Wm)(a,{to:"#_1-首先要在微信公众号后台填写服务器信息。"},{default:(0,t.w5)((()=>[(0,t.Uk)("1.首先要在微信公众号后台填写服务器信息。")])),_:1})]),(0,t._)("li",null,[(0,t.Wm)(a,{to:"#_2-在服务器上配置具体代码反馈微信的验证"},{default:(0,t.w5)((()=>[(0,t.Uk)("2.在服务器上配置具体代码反馈微信的验证")])),_:1})]),(0,t._)("li",null,[(0,t.Wm)(a,{to:"#_3-和关注、取消关注相关的业务逻辑代码"},{default:(0,t.w5)((()=>[(0,t.Uk)("3.和关注、取消关注相关的业务逻辑代码")])),_:1})])])]),o,(0,t._)("p",null,[(0,t.Uk)("具体可看微信的文档："),(0,t._)("a",c,[(0,t.Uk)("https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421135319"),(0,t.Wm)(l)])]),i,(0,t._)("p",null,[(0,t.Uk)("微信的其他事件推送："),(0,t._)("a",u,[(0,t.Uk)("https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421140454"),(0,t.Wm)(l)])])],64)}]])},3744:(n,s)=>{s.Z=(n,s)=>{const a=n.__vccOpts||n;for(const[n,t]of s)a[n]=t;return a}}}]);